<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Work Detail</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="/img/favicon.png" />
  <style>
    .carousel-container {
      overflow: hidden;
      position: relative;
    }

    .carousel-track {
      display: flex;
      transition: transform 0.3s ease;
      will-change: transform;
    }

    .carousel-track img {
      flex-shrink: 0;
      width: 100%;
      object-fit: contain;
      max-height: 70vh;
    }
  </style>
</head>

<body>
  <header>
    <a href="./index.html">Jang da eun</a>
  </header>
  <nav>
    <a class="tab" data-tab="art">Art</a>
    <a class="tab" data-tab="text">Text</a>
    <a class="tab" data-tab="cv" href="./index.html?nav=cv">CV</a>
    <a class="tab" data-tab="contact" href="./index.html?nav=contact">Contact</a>
  </nav>
  <div class="page-wrapper">
    <div class="subnav" id="subnavContainer">
      <a class="subtab" data-subtab="works">Works</a>
      <a class="subtab" data-subtab="drawing">Drawing</a>
      <a class="subtab" data-subtab="statement">Statement</a>
      <a class="subtab" data-subtab="text">Text</a>
    </div>
    <div class="content-area">
      <div class="content">
        <div class="detail">
          <div class="carousel-container">
            <div class="carousel-track" id="carouselTrack"></div>
          </div>
          <div class="slider" id="previewSlider"></div>
          <div id="detailText"></div>
        </div>
        <div class="back-btn">&lt; Show all</div>
      </div>
    </div>
  </div>

  <footer>
    <div class="top"></div>
    <div class="btm">Â© 2025 Jang Da Eun - All Rights Reserved</div>
  </footer>

  <script type="module">
    import { contents } from './data.js';

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const nav = params.get('nav');
    const subnav = params.get('subnav');

    if (nav) {
      const navTab = document.querySelector(`.tab[data-tab="${nav}"]`);
      if (navTab) navTab.classList.add('active');
    }

    if (subnav) {
      const subTab = document.querySelector(`.subtab[data-subtab="${subnav}"]`);
      if (subTab) subTab.classList.add('active');
    }

    const subnavMap = {
      art: ['works', 'drawing'],
      text: ['statement', 'text']
    };

    const allowedSubtabs = subnavMap[nav] || [];
    document.querySelectorAll('.subtab').forEach(tab => {
      const type = tab.getAttribute('data-subtab');
      tab.style.display = allowedSubtabs.includes(type) ? 'inline-block' : 'none';
    });

    const detail = contents.find(item => item.id === id);
    const carouselTrack = document.getElementById('carouselTrack');
    const detailText = document.getElementById('detailText');
    const previewSlider = document.getElementById('previewSlider');

    let currentIndex = 0;

    function renderCarousel(images) {
      carouselTrack.innerHTML = images.map((src, i) => `
        <img src="${src}" loading="lazy" class="${i === 0 ? 'active' : ''}" />
      `).join('');
      updateSliderActive(0);
    }

    function updateSliderActive(index) {
      const thumbs = previewSlider.querySelectorAll('img');
      thumbs.forEach((el, i) => {
        el.classList.toggle('active', i === index);
      });
    }

    function initSlider(images) {
      previewSlider.innerHTML = images.map((src, i) => `
        <img src="${src}" loading="lazy" data-index="${i}" class="${i === 0 ? 'active' : ''}" />
      `).join('');

      previewSlider.querySelectorAll('img').forEach(img => {
        img.addEventListener('click', () => {
          goToIndex(parseInt(img.dataset.index));
        });
      });
    }

    function goToIndex(index) {
      if (!detail || !detail.images || index < 0 || index >= detail.images.length) return;
      currentIndex = index;
      const width = carouselTrack.offsetWidth;
      carouselTrack.style.transform = `translateX(-${width * index}px)`;
      updateSliderActive(index);
    }

    let startX = 0;
    let isDragging = false;

    carouselTrack.addEventListener('mousedown', e => {
      startX = e.clientX;
      isDragging = true;
    });

    document.addEventListener('mouseup', e => {
      if (!isDragging) return;
      const delta = e.clientX - startX;
      if (Math.abs(delta) > 50) {
        if (delta < 0 && currentIndex < detail.images.length - 1) {
          goToIndex(currentIndex + 1);
        } else if (delta > 0 && currentIndex > 0) {
          goToIndex(currentIndex - 1);
        }
      }
      isDragging = false;
    });

    carouselTrack.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      isDragging = true;
    });

    carouselTrack.addEventListener('touchend', e => {
      const delta = e.changedTouches[0].clientX - startX;
      if (Math.abs(delta) > 50) {
        if (delta < 0 && currentIndex < detail.images.length - 1) {
          goToIndex(currentIndex + 1);
        } else if (delta > 0 && currentIndex > 0) {
          goToIndex(currentIndex - 1);
        }
      }
      isDragging = false;
    });

    if (detail) {
      detailText.innerHTML = `
        <h3>${detail.title}</h3>
        ${detail.subtitle ? `<p><strong>${detail.subtitle}</strong></p>` : ''}
        <p>${detail.body}</p>
      `;

      if (detail.images && detail.images.length > 0) {
        renderCarousel(detail.images);
        initSlider(detail.images);
      }
    }

    const backBtn = document.querySelector('.back-btn');
    if (backBtn && nav && subnav && id) {
      backBtn.innerHTML = `&lt; Show all ${subnav}`;
      backBtn.addEventListener('click', () => {
        localStorage.setItem('scrollToId', id);
        const url = new URL('/index.html', window.location.origin);
        url.searchParams.set('nav', nav);
        url.searchParams.set('subnav', subnav);
        url.searchParams.set('id', id);
        window.location.href = url.toString();
      });
    }

    document.querySelectorAll('.tab, .subtab').forEach(tab => {
      tab.addEventListener('click', () => {
        const navAttr = tab.classList.contains('tab') ? tab.dataset.tab : params.get('nav');
        const subnavAttr = tab.classList.contains('subtab') ? tab.dataset.subtab : null;

        const url = new URL('./index.html', window.location.origin);
        url.searchParams.set('nav', navAttr);
        if (subnavAttr) url.searchParams.set('subnav', subnavAttr);

        window.location.href = url.toString();
      });
    });
  </script>
</body>

</html>

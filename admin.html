<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Admin | jangdaeun.com</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        aside {
            width: 35%;
            border-right: 1px solid #ddd;
            padding: 16px;
            overflow-y: auto;
        }

        main {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        h2 {
            margin-top: 0;
        }

        input,
        textarea,
        select {
            width: 100%;
            margin: 4px 0 8px;
            padding: 6px;
        }

        textarea {
            min-height: 80px;
        }

        .bodytext {
            min-height: 200px;
        }

        button {
            margin: 4px;
            padding: 6px 10px;
            cursor: pointer;
        }

        .item {
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .item:hover {
            background: #f5f5f5;
        }

        .item.active {
            background: #e0e7ff;
        }

        .controls {
            margin-top: 10px;
        }

        .dropzone {
            border: 2px dashed #bbb;
            border-radius: 8px;
            padding: 14px;
            text-align: center;
            color: #666;
            user-select: none;
        }

        .dropzone.dragover {
            background: #eef7ff;
            border-color: #5b9cff;
            color: #2b6bbf;
        }

        #imgPreview:not([src]),
        #imgPreview[src=""] {
            display: none;
        }

        .preview-single img {
            max-width: 100px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-top: 8px;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .preview-grid .item {
            position: relative;
            border: 1px solid #eee;
            border-radius: 6px;
            overflow: hidden;
        }

        .preview-grid img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            display: block;
        }

        .preview-grid .remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #0008;
            color: #fff;
            border: none;
            border-radius: 12px;
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .item.dragging {
            opacity: .5;
        }

        /* 그룹 스타일 */
        .group {
            margin: 10px 0;
            border: 1px solid #e9e9e9;
            border-radius: 8px;
            overflow: hidden;
        }

        .group-title {
            margin: 0;
            padding: 8px 10px;
            background: #fafafa;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #333;
        }

        .group-list {
            min-height: 8px;
        }

        #upload {
            display: none;
        }
    </style>
</head>

<body>
    <aside>
        <h2>Contents</h2>
        <input type="text" id="search" placeholder="Search title..." />
        <div id="list"></div>
        <div class="controls">
            <button id="add">➕ Add New</button>
            <button id="duplicate">📄 Duplicate</button>
            <button id="delete">🗑️ Delete</button>
            <button id="download">⬇️ Download data.js</button>
            <input type="file" id="upload" accept=".js" />
        </div>
    </aside>

    <main>
        <h2>Editor</h2>
        <form id="editor">
            <label>ID <input name="id" required /></label>
            <label>Nav <select name="nav">
                    <option>art</option>
                    <option>text</option>
                </select></label>
            <label>Subnav <select name="subnav">
                    <option>works</option>
                    <option>drawings</option>
                    <option>reviews</option>
                    <option>texts</option>
                </select></label>
            <label>Title <input name="title" /></label>
            <label>Subtitle <textarea name="subtitle"></textarea></label>
            <label>Body <textarea name="body" class="bodytext"></textarea></label>
            <label>Link <input name="link" placeholder="https://... 또는 img/file.pdf" /></label>

            <!-- Img: 히든 값 + 드롭존 + 프리뷰 -->
            <label>Img</label>
            <input type="hidden" name="img">
            <div class="dropzone" id="imgDrop">📤 단일 이미지 드롭 또는 클릭하여 선택</div>
            <input type="file" id="imgFile" accept="image/*" hidden>
            <div class="preview-single"><img id="imgPreview" alt="img preview"></div>

            <!-- Images: 히든 값 + 드롭존 + 프리뷰 -->
            <label>Images</label>
            <input type="hidden" name="images">
            <div class="dropzone" id="imagesDrop">📤 여러 이미지 드롭 또는 클릭하여 선택</div>
            <input type="file" id="imagesFiles" accept="image/*" multiple hidden>
            <div class="preview-grid" id="imagesPreview"></div>


            <button type="submit">💾 Save</button>
            <button type="button" id="preview">🔍 Preview</button>
        </form>
    </main>

    <script src="./data.js"></script>
    <script>
        const listEl = document.getElementById('list');
        const form = document.getElementById('editor');
        const search = document.getElementById('search');
        let items = window.contents ? [...window.contents] : [];
        let currentIndex = -1;

        function renderList(filter = '') {
            listEl.innerHTML = '';
            const f = (filter || '').toLowerCase();
            const filtered = items.filter(i => (i.title || '').toLowerCase().includes(f));
            const keyOf = it => `${it.nav || 'unknown'} / ${it.subnav || 'unknown'}`;
            const groups = new Map();
            filtered.forEach(it => {
                const k = keyOf(it);
                if (!groups.has(k)) groups.set(k, []);
                groups.get(k).push(it);
            });

            const order = ['art / works', 'art / drawings', 'text / reviews', 'text / texts'];
            const groupKeys = Array.from(groups.keys()).sort((a, b) => {
                const ia = order.indexOf(a), ib = order.indexOf(b);
                if (ia === -1 && ib === -1) return a.localeCompare(b);
                if (ia === -1) return 1;
                if (ib === -1) return -1;
                return ia - ib;
            });

            groupKeys.forEach(k => {
                const [nav, subnav] = k.split(' / ').map(s => s.trim());
                const section = document.createElement('section');
                section.className = 'group';
                const title = document.createElement('h3');
                title.className = 'group-title';
                title.textContent = `${nav} / ${subnav}`;
                section.appendChild(title);

                const ul = document.createElement('div');
                ul.className = 'group-list';
                ul.dataset.group = `${nav}|${subnav}`;
                section.appendChild(ul);

                const arr = groups.get(k) || [];
                arr.forEach(it => {
                    const row = document.createElement('div');
                    row.className = 'item' + (items[currentIndex]?.id === it.id ? ' active' : '');
                    row.textContent = `${it.id} – ${it.title || '(no title)'}`;
                    row.dataset.id = it.id;
                    row.draggable = !filter;
                    row.addEventListener('click', () => trySelectItemById(it.id));
                    ul.appendChild(row);
                });

                listEl.appendChild(section);
            });

            if (!filter) enableGroupReorder();
        }

        let currentSnapshot = '';

        function takeSnapshot() {
            const data = {};
            [...form.elements].forEach(el => {
                if (el.name) data[el.name] = el.value;
            });
            return JSON.stringify(data);
        }

        function markClean() { currentSnapshot = takeSnapshot(); }
        function isDirty() { return currentSnapshot !== takeSnapshot(); }


        function selectItemById(id) {
            const idx = items.findIndex(it => it.id === id);
            if (idx > -1) selectItem(idx);
        }

        function enableGroupReorder() {
            const lists = listEl.querySelectorAll('.group-list');
            let dragState = { id: null, fromList: null };

            lists.forEach(list => {
                list.querySelectorAll('.item').forEach(item => {
                    item.addEventListener('dragstart', e => {
                        dragState.id = item.dataset.id;
                        dragState.fromList = list;
                        item.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    item.addEventListener('dragend', () => item.classList.remove('dragging'));
                });
            });

            lists.forEach(list => {
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const dragging = list.querySelector('.item.dragging');
                    if (!dragging || dragState.fromList !== list) return;
                    const after = getDragInsertTarget(list, e.clientY);
                    if (!after) list.appendChild(dragging);
                    else list.insertBefore(dragging, after);
                });

                list.addEventListener('drop', e => {
                    e.preventDefault();
                    const dragging = list.querySelector('.item.dragging');
                    if (!dragging) return;
                    dragging.classList.remove('dragging');
                    if (dragState.fromList === list) {
                        commitGroupOrder(list.dataset.group, list);
                    } else renderList(search.value);
                });
            });
        }

        function getDragInsertTarget(container, y) {
            const siblings = [...container.querySelectorAll('.item:not(.dragging)')];
            let closest = { offset: Number.NEGATIVE_INFINITY, el: null };
            for (const el of siblings) {
                const rect = el.getBoundingClientRect();
                const offset = y - rect.top - rect.height / 2;
                if (offset < 0 && offset > closest.offset) closest = { offset, el };
            }
            return closest.el;
        }

        function commitGroupOrder(groupKey, listElRef) {
            const [nav, subnav] = groupKey.split('|');
            const orderedIds = [...listElRef.querySelectorAll('.item')].map(el => el.dataset.id);
            const inGroup = it => (it.nav || '') === nav && (it.subnav || '') === subnav;
            const groupItems = items.filter(inGroup);
            const others = items.filter(it => !inGroup(it));
            const map = new Map(groupItems.map(it => [it.id, it]));
            const reordered = orderedIds.map(id => map.get(id)).filter(Boolean);
            items = [...others, ...reordered];
            renderList('');
            if (orderedIds.length) selectItemById(orderedIds[0]);
        }

        function selectItem(index) {
            currentIndex = index;
            const item = items[index];
            [...form.elements].forEach(el => {
                if (!el.name) return;
                if (el.name === 'images') {
                    // 배열 → 줄바꿈 문자열로 히든 필드에 저장
                    el.value = (item.images || []).join('\n');
                } else if (el.tagName.toLowerCase() === 'textarea') {
                    // textarea는 화면에서 줄바꿈 보이도록 <br> → \n
                    el.value = (item[el.name] || '').replace(/<br\s*\/?>/gi, '\n');
                } else {
                    el.value = item[el.name] || '';
                }
            });
            refreshSinglePreview();
            refreshImagesPreview();
            renderList(search.value);
            markClean();
        }


        form.onsubmit = e => {
            e.preventDefault();
            const data = {};
            [...form.elements].forEach(el => {
                if (!el.name) return;

                if (el.name === 'images') {
                    // ✅ 줄바꿈/쉼표 기준 split → 배열
                    data.images = el.value.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
                } else {
                    let val = el.value;
                    if (el.tagName.toLowerCase() === 'textarea') {
                        // textarea는 저장 시 줄바꿈을 <br>로 변환해 data.js에 기록
                        val = val.replace(/\r?\n/g, '<br>');
                    }
                    data[el.name] = val.trim();
                }
            });
            if (currentIndex >= 0) items[currentIndex] = data; else items.push(data);
            renderList(search.value);
            alert('Saved!');
            markClean();
        };

        document.getElementById('add').onclick = () => {
            const draft = {
                id: generateNewId('new'),
                nav: 'art',
                subnav: 'works',
                title: '',
                subtitle: '',
                body: '',
                link: '',
                img: '',
                images: []
            };
            // 리스트에 실제 추가
            items.push(draft);

            // 좌측 패널 갱신 + 방금 만든 항목 선택
            renderList(search.value);
            selectItemById(draft.id);

            // ID 입력부터 바로 치기 좋게 포커스
            const idInput = form.querySelector('input[name="id"]');
            if (idInput) {
                idInput.focus();
                idInput.select();
            }
        };
        document.getElementById('duplicate').onclick = () => {
            if (currentIndex < 0) return;
            const copy = { ...items[currentIndex], id: items[currentIndex].id + '_copy' };
            items.push(copy); renderList(search.value);
        };
        document.getElementById('delete').onclick = () => {
            if (currentIndex < 0) return;
            if (confirm('Delete this item?')) { items.splice(currentIndex, 1); currentIndex = -1; renderList(search.value); }
        };
        document.getElementById('download').onclick = () => {
            const blob = new Blob(['window.contents = ' + JSON.stringify(items, null, 2) + ';'], { type: 'application/javascript' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'data.js'; a.click();
        };
        document.getElementById('upload').onchange = e => {
            const file = e.target.files[0]; if (!file) return;
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const sandbox = {}; eval(ev.target.result);
                    if (window.contents) items = [...window.contents];
                    else if (sandbox.contents) items = [...sandbox.contents];
                    renderList();
                } catch (err) { alert('Error reading file:' + err); }
            };
            r.readAsText(file);
        };
        document.getElementById('preview').onclick = () => {
            const nav = form.nav.value || 'art', sub = form.subnav.value || 'works', id = form.id.value || '';
            if (!id) return alert('ID required');
            const url = `./detail.html?id=${id}&nav=${nav}&subnav=${sub}`;
            window.open(url, '_blank');
        };

        const imgDrop = document.getElementById('imgDrop');
        const imgFile = document.getElementById('imgFile');
        const imgPreview = document.getElementById('imgPreview');
        const imagesDrop = document.getElementById('imagesDrop');
        const imagesFiles = document.getElementById('imagesFiles');
        const imagesPreview = document.getElementById('imagesPreview');

        function setDropzoneHandlers(zone, onFiles) {
            const stop = e => { e.preventDefault(); e.stopPropagation(); };
            zone.addEventListener('dragover', e => { stop(e); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', e => { stop(e); zone.classList.remove('dragover'); });
            zone.addEventListener('drop', e => {
                stop(e); zone.classList.remove('dragover');
                const files = [...e.dataTransfer.files].filter(f => f.type.startsWith('image/'));
                if (files.length) onFiles(files);
            });
            zone.addEventListener('click', () => { if (zone === imgDrop) imgFile.click(); else imagesFiles.click(); });
        }

        // 히든 필드 접근 유틸
        const hiddenImg = form.elements['img'];
        const hiddenImages = form.elements['images'];

        async function applySingleImage(file) {
            hiddenImg.value = 'img/' + file.name;
            imgPreview.src = URL.createObjectURL(file);
        }

        async function applyMultiImages(files) {
            // 히든 필드의 줄바꿈 문자열을 배열로 → 새 파일 추가 → 다시 줄바꿈으로 저장
            const cur = hiddenImages.value.split(/\n|,/).map(s => s.trim()).filter(Boolean);
            files.forEach(f => cur.push('img/' + f.name));
            hiddenImages.value = cur.join('\n');
            refreshImagesPreview();
        }

        function refreshSinglePreview() {
            const v = hiddenImg.value.trim();
            if (!v) imgPreview.removeAttribute('src');
            else imgPreview.src = v;
        }

        function refreshImagesPreview() {
            const list = hiddenImages.value.split(/\n|,/).map(s => s.trim()).filter(Boolean);
            imagesPreview.innerHTML = '';
            list.forEach((src, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'item';
                const img = document.createElement('img');
                img.src = src;
                const rm = document.createElement('button');
                rm.className = 'remove'; rm.type = 'button'; rm.textContent = '×';
                rm.onclick = () => {
                    const arr = hiddenImages.value.split(/\n|,/).map(s => s.trim()).filter(Boolean);
                    arr.splice(idx, 1);
                    hiddenImages.value = arr.join('\n');
                    refreshImagesPreview();
                };
                wrap.appendChild(img); wrap.appendChild(rm);
                imagesPreview.appendChild(wrap);
            });
        }


        setDropzoneHandlers(imgDrop, files => applySingleImage(files[0]));
        setDropzoneHandlers(imagesDrop, files => applyMultiImages(files));
        imgFile.onchange = e => { const f = e.target.files[0]; if (f) applySingleImage(f); };
        imagesFiles.onchange = e => { const fs = [...e.target.files]; if (fs.length) applyMultiImages(fs); };

        search.oninput = () => renderList(search.value);
        renderList();
        requestAnimationFrame(selectDefaultOnload); // 온보딩 기본 선택

        function selectDefaultOnload() {
            // 이미 선택된 항목이 있으면 건너뜀
            if (currentIndex !== -1) return;

            // art / works 중 첫 번째
            const firstAW = items.find(it => (it.nav || '') === 'art' && (it.subnav || '') === 'works');
            const targetId = firstAW ? firstAW.id : (items[0]?.id || null);

            if (targetId) {
                // 리스트가 그려진 다음에 선택하도록 한 틱 지연
                setTimeout(() => { selectItemById(targetId); }, 0);
            }
        }


        function generateNewId(base = 'new') {
            let i = 1;
            let id = `${base}-${i}`;
            const has = (x) => items.some(it => it.id === x);
            while (has(id)) { i += 1; id = `${base}-${i}`; }
            return id;
        }

        function trySelectItemById(id) {
            // 이미 선택된 항목이면 무시
            if (items[currentIndex]?.id === id) return;

            if (isDirty()) {
                const ok = confirm('수정한 내용이 저장되지 않았어요!\n저장하지 않고 이동하시겠어요?');
                if (!ok) return; // 사용자가 취소하면 이동 중단
            }
            selectItemById(id);
        }

        let formChanged = false;
        document.querySelector('form').addEventListener('input', () => {
            formChanged = true;
        });

        window.addEventListener('beforeunload', (e) => {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

    </script>
</body>

</html>